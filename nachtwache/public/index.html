<!DOCTYPE html>
<html>
  <head>
    <title>Nachtwache Index</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
      #mover {
        position:   absolute;
        left:       0px;
        top:        0px;
        width: 40px;
        height: 40px;
      }
      
    </style>
    <script src="js/jquery-3.2.1.js" type="text/javascript"></script>
    <script type="text/javascript">
      var chessBoard = {
        imgSrcs: {r: './img/bR.png',
                  n: './img/bN.png',
                  b: './img/bB.png',
                  q: './img/bQ.png',
                  k: './img/bK.png',
                  p: './img/bP.png',
                  R: './img/wR.png',
                  N: './img/wN.png',
                  B: './img/wB.png',
                  Q: './img/wQ.png',
                  K: './img/wK.png',
                  P: './img/wP.png'},

        imgObjs: {},
        
        mouseStatus: {},
        
        FENPos: "rnbqkbnr/ppp1pppp/3p4/8/4P3/8/PPPP1PPP/RNBQKBNR",
        
        matrix: (function () { //TODO: Matrix to fen!
          //administration of position vi FEN String
          var m = [];
          for(i = 0; i < 8; i++) {
            m[i] = ['','','','','','','',''];
          }
          return m;
        }()),
        
        FENPosToMatrix: function () {
          var rows = this.FENPos.split('/');
          rows.forEach(function (row, y) {
            var x = 0;
            var pieces = row.split('');
            pieces.forEach(function (p, idx) {
              if (p.match(/\d/)) {
                var toX = x+parseInt(p);
                while(x < toX) {
                  //console.log(x, toX);
                  chessBoard.matrix[y][x] = '';
                  chessBoard.rawDraw(x++, y, 1, 1);
                }
                //console.log("NUMER: "+p);
              } else if (p.match(/[rnbqkpRNBQKP]/)) {
                chessBoard.rawDraw(x, y, 1, 1, chessBoard.imgObjs[p]);
                //console.log("VALID LETTER: "+p);
                chessBoard.matrix[y][x] = p;
                x++;
              } else {
                //console.log("INVALID CHAR: "+p);
                x++;
              }
            });
          });
          //console.table(this.matrix);
        },
        
        init: function () {
          this.canvas = document.querySelector('#canvas');
          this.context = canvas.getContext('2d');
          this.context.scale(40, 40);
          var k = 0;
          this.FENPosToMatrix();
          this.drawLabels();
          
          this.addEvents();
        },
        
        getCoords: function (e) {
          var xPos = e.clientX - parseInt(chessBoard.canvas.style.left);
          var yPos = e.clientY - parseInt(chessBoard.canvas.style.top);
          return chessBoard.getSquareForCoordinates(xPos, yPos);
        },
        
        getXY: function (e) {
          var xPos = e.clientX - parseInt(chessBoard.canvas.style.left);
          var yPos = e.clientY - parseInt(chessBoard.canvas.style.top);
          return chessBoard.getRawSquareForCoordinates(xPos, yPos);
        },
        
        getImgKeyForXY: function (x, y) {
          return chessBoard.matrix[y][x];
        },
        
        addEvents: function () {
          this.canvas.addEventListener('mousedown', function (e) {
            e.stopPropagation();
            var xy = chessBoard.getXY(e);
            console.table(chessBoard.matrix);
            chessBoard.mouseStatus = {mousedown: 1};
            var moveImgKey = chessBoard.getImgKeyForXY(xy[0], xy[1]);
            var moveImg = chessBoard.imgObjs[moveImgKey];
            console.log(xy, moveImg);
            $('#mover').append(moveImg);
            
            $('#mover').css({
                              'visibility': 'visible',
                              'left': (e.clientX - 20) + 'px',
                              'top': (e.clientY - 20) + 'px'
                            });
            //$('#mover').css('background-color',
            //                ((xy[0] + xy[1]) % 2) ? 'lightblue' : 'lightgray');
          });
          this.canvas.addEventListener('mouseup', function (e) {
            e.stopPropagation();
            //var coords = chessBoard.getCoords(e);
            //var prevMouseStatus = chessBoard.mouseStatus;
            //chessBoard.mouseStatus = { released: 'inside', x: coords[0], y: coords[1] };
            //console.log('moved from '+prevMouseStatus.x+prevMouseStatus.y+
                        //' to '+chessBoard.mouseStatus.x+chessBoard.mouseStatus.y);
            chessBoard.mouseStatus = {mousedown: 0};
            $('#mover').css({'left': '350px', 'top': '350px', 'background-color': 'green' });
            $('#mover').empty();
          });
          document.addEventListener('mouseup', function (e) {
            var coords = chessBoard.getCoords(e);
            var prevMouseStatus = chessBoard.mouseStatus;
            chessBoard.mouseStatus = { released: 'outside', x: coords[0], y: coords[1] };
            //console.log('moved from '+prevMouseStatus.x+prevMouseStatus.y+
                        //' to OUTSIDE');
            chessBoard.mouseStatus = {mousedown: 0};
            $('#mover').css({'left': '350px', 'top': '350px' });
            $('#mover').empty();
          });
          
          document.addEventListener('mousemove', function (e) {
            e.preventDefault();
            if (chessBoard.mouseStatus.mousedown) {
              e.stopPropagation();
              $('#mover').css({
                                'left': (e.clientX - 20) + 'px',
                                'top': (e.clientY - 20) + 'px'
                            });
            }
          });
        },
        
        draw: function(col, row, w, h, img) {
          context.fillRect(indexForColLetter(col), indexForRowNumber(row), 1, 1);
          if(img) {
            this.context.drawImage(img, col, row, w, h);
          }
        },

        rawDraw: function (x, y, w, h, img) {
          this.context.fillStyle = (x + y) % 2 ? 'lightblue' : 'lightgray';
          this.context.fillRect(x, y, w, h);
          if(img) {
            this.context.drawImage(img, x, y, w, h);
          }
        },

        indexForColLetter: function (colLetter) {
          return 'abcdefgh'.indexOf(colLetter.toLowerCase());
        },

        indexForRowNumber: function (rowNumber) {
          return 8 - rowNumber - 1;
        },

        colLetterForIndex: function (idx) {
          return 'abcdefgh'.split('')[idx];
        },

        rowNumberForIndex: function (idx) {
          return 8 - idx;
        },

        drawLabels: function () {
          //console.log(this.canvas);
          this.context = this.canvas.getContext('2d');
          //console.log(this.context);
          this.context.scale(0.025, 0.025);
          this.context.fillStyle = 'black';
          this.context.font = '32px serif';
          this.context.fillText('a', 9, 345);
          this.context.fillText('b', 49, 345);
          this.context.fillText('c', 89, 345);
          this.context.fillText('d', 129, 345);
          this.context.fillText('e', 169, 345);
          this.context.fillText('f', 209, 345);
          this.context.fillText('g', 249, 345);
          this.context.fillText('h', 289, 345);
          this.context.fillText('1', 329, 32);
          this.context.fillText('2', 329, 72);
          this.context.fillText('3', 329, 112);
          this.context.fillText('4', 329, 152);
          this.context.fillText('5', 329, 192);
          this.context.fillText('6', 329, 232);
          this.context.fillText('7', 329, 272);
          this.context.fillText('8', 329, 312);
          this.context.scale(40, 40);
        },
        getRawSquareForCoordinates: function (left, top) {
          return [Math.floor(left / 40), Math.floor(top / 40)];
        },
        getSquareForCoordinates: function (left, top) {
          var xyArray = chessBoard.getRawSquareForCoordinates(left, top);
          //console.log(xyArray);
          return [chessBoard.colLetterForIndex(xyArray[0]),
                  chessBoard.rowNumberForIndex(xyArray[1])];
        }
      };
      
      for (key in chessBoard.imgSrcs) {
        //console.log(key);
        let pic = new Image();
        pic.src = chessBoard.imgSrcs[key];
        pic.style.width = '40px';
        pic.style.height = '40px';
        chessBoard.imgObjs[key] = pic;
      }
      //console.log(chessBoard.imgObjs);
//      console.table(chessBoard.matrix);
    </script>
  </head>
  <body onload="chessBoard.init()">
    <canvas id="canvas" width="360" height="360" style="position:absolute; left:20px; top:20px;"></canvas>
    <div id="mover"></div>
  </body>
</html>
